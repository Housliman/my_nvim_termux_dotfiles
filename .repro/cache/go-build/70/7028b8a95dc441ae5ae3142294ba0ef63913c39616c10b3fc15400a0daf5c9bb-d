// Code generated by cmd/cgo; DO NOT EDIT.

//line /home/username/go/pkg/mod/github.com/godror/godror@v0.41.0/subscr.go:1:1
// Copyright 2017, 2020 The Godror Authors
//
//
// SPDX-License-Identifier: UPL-1.0 OR Apache-2.0

package godror

/*
#include <stdlib.h>
#include <stdio.h>
#include "dpiImpl.h"

void CallbackSubscrDebug(void *context, dpiSubscrMessage *message);

*/
import _ "unsafe"

import (
	"context"
	"errors"
	"fmt"
	"log"
	"runtime"
	"strings"
	"sync"
	"unsafe"
)

// SubscriptionOption is for setting various parameters of the Subscription.
type SubscriptionOption func(*subscriptionParams)

// SubscrHostPort is a SubscriptionOption that sets tha IPAddress and Port to the specified values.
//
// The address is on which the subscription listens to receive notifications,
// for a server-initiated connection.
//
// The address can be an IPv4 address in dotted decimal format such as 192.1.2.34
// or an IPv6 address in hexadecimal format such as 2001:0db8:0000:0000:0217:f2ff:fe4b:4ced.
//
// By default (address is the empty string), an IP address will be selected by the Oracle client.
//
// The port number on which to receive notifications, for a server-initiated connection.
//
// The default value of 0 means that a port number will be selected by the Oracle client.
func SubscrHostPort(address string, port uint32) SubscriptionOption {
	return func(p *subscriptionParams) {
		p.IPAddress, p.Port = address, port
	}
}

// SubscrClientInitiated sets whether the subscription is client-initated.
func SubscrClientInitiated(b bool) SubscriptionOption {
	return func(p *subscriptionParams) {
		p.ClientInitiated = b
	}
}

// subscrParams are parameters for a new Subscription.
type subscriptionParams struct {
	// IPAddress on which the subscription listens to receive notifications,
	// for a server-initiated connection.
	//
	// The IP address can be an IPv4 address in dotted decimal format such as 192.1.2.34
	// or an IPv6 address in hexadecimal format such as 2001:0db8:0000:0000:0217:f2ff:fe4b:4ced.
	//
	// By default, an IP address will be selected by the Oracle client.
	IPAddress string

	// Port number on which to receive notifications, for a server-initiated connection.
	// The default value of 0 means that a port number will be selected by the Oracle client.
	Port uint32

	// ClientInitiated specifies whether a client or a server initiated connection should be created.
	//
	// This feature is only available when Oracle Client 19.4
	// and Oracle Database 19.4 or higher are being used.
	ClientInitiated bool
}

// Cannot pass *Subscription to C, so pass an uint64 that points to this map entry
var (
	subscriptionsMu sync.Mutex
	subscriptions   = make(map[uint64]*Subscription)
	subscriptionsID uint64
)

// CallbackSubscr is the callback for C code on subscription event.
//
//export CallbackSubscr
func CallbackSubscr(ctx unsafe.Pointer, message * /*line :90:50*/_Ctype_dpiSubscrMessage /*line :90:68*/) {
	log.Printf("CB %p %+v", ctx, message)
	if ctx == nil {
		return
	}
	subscriptionsMu.Lock()
	subscr := subscriptions[*((*uint64)(ctx))]
	subscriptionsMu.Unlock()

	getRows := func(rws * /*line :99:23*/_Ctype_dpiSubscrMessageRow /*line :99:44*/, rwsNum  /*line :99:53*/_Ctype_uint32_t /*line :99:63*/) []RowEvent {
		if rwsNum == 0 {
			return nil
		}
		//cRws := (*((*[maxArraySize]C.dpiSubscrMessageRow)(unsafe.Pointer(rws))))[:int(rwsNum)]
		cRws := unsafe.Slice(rws, rwsNum)
		rows := make([]RowEvent, len(cRws))
		for i, row := range cRws {
			rows[i] = RowEvent{
				Operation: Operation(row.operation),
				Rowid:     ( /*line :109:16*/_Cfunc_GoStringN /*line :109:26*/)(row.rowid,  /*line :109:39*/_Ctype_int /*line :109:44*/(row.rowidLength)),
			}
			//C.free(unsafe.Pointer(row.rowid))
		}
		return rows
	}
	getTables := func(tbls * /*line :115:26*/_Ctype_dpiSubscrMessageTable /*line :115:49*/, tblsNum  /*line :115:59*/_Ctype_uint32_t /*line :115:69*/) []TableEvent {
		if tblsNum == 0 {
			return nil
		}
		//cTbls := (*((*[maxArraySize]C.dpiSubscrMessageTable)(unsafe.Pointer(tbls))))[:int(tblsNum)]
		cTbls := unsafe.Slice(tbls, tblsNum)
		tables := make([]TableEvent, len(cTbls))
		for i, tbl := range cTbls {
			tables[i] = TableEvent{
				Operation: Operation(tbl.operation),
				Name:      ( /*line :125:16*/_Cfunc_GoStringN /*line :125:26*/)(tbl.name,  /*line :125:38*/_Ctype_int /*line :125:43*/(tbl.nameLength)),
				Rows:      getRows(tbl.rows, tbl.numRows),
			}
			//C.free(unsafe.Pointer(tbl.name))
		}
		return tables
	}
	getQueries := func(qrys * /*line :132:27*/_Ctype_dpiSubscrMessageQuery /*line :132:50*/, qrysNum  /*line :132:60*/_Ctype_uint32_t /*line :132:70*/) []QueryEvent {
		if qrysNum == 0 {
			return nil
		}
		//cQrys := (*((*[maxArraySize]C.dpiSubscrMessageQuery)(unsafe.Pointer(qrys))))[:int(qrysNum)]
		cQrys := unsafe.Slice(qrys, qrysNum)
		queries := make([]QueryEvent, len(cQrys))
		for i, qry := range cQrys {
			queries[i] = QueryEvent{
				ID:        uint64(qry.id),
				Operation: Operation(qry.operation),
				Tables:    getTables(qry.tables, qry.numTables),
			}
		}
		return queries
	}
	var err error
	if message.errorInfo != nil {
		err = fromErrorInfo(*message.errorInfo)
	}

	evt := Event{
		Err:     err,
		Type:    EventType(message.eventType),
		DB:      ( /*line :156:12*/_Cfunc_GoStringN /*line :156:22*/)(message.dbName,  /*line :156:40*/_Ctype_int /*line :156:45*/(message.dbNameLength)),
		Tables:  getTables(message.tables, message.numTables),
		Queries: getQueries(message.queries, message.numQueries),
	}
	subscr.callback(evt)
}

// Event for a subscription.
type Event struct {
	Err     error
	DB      string
	Tables  []TableEvent
	Queries []QueryEvent
	Type    EventType
}

// QueryEvent is an event of a Query.
type QueryEvent struct {
	Tables []TableEvent
	ID     uint64
	Operation
}

// TableEvent is for a Table-related event.
type TableEvent struct {
	Name string
	Rows []RowEvent
	Operation
}

// RowEvent is for row-related event.
type RowEvent struct {
	Rowid string
	Operation
}

// Subscription for events in the DB.
type Subscription struct {
	conn      *conn
	dpiSubscr * /*line :195:13*/_Ctype_dpiSubscr /*line :195:24*/
	callback  func(Event)
	ID        uint64
}

// NewSubscription creates a new Subscription in the DB.
//
// Make sure your user has CHANGE NOTIFICATION privilege!
//
// This code is EXPERIMENTAL yet!
func (c *conn) NewSubscription(name string, cb func(Event), options ...SubscriptionOption) (*Subscription, error) {
	if !c.params.EnableEvents {
		return nil, errors.New("subscription must be allowed by specifying \"enableEvents=1\" in the connection parameters")
	}
	var p subscriptionParams
	for _, o := range options {
		o(&p)
	}
	subscr := Subscription{conn: c, callback: cb}
	params := (* /*line :214:14*/_Ctype_dpiSubscrCreateParams /*line :214:37*/)(( /*line :214:39*/_Cfunc__CMalloc /*line :214:46*/)(( /*line :214:48*/_Ciconst_sizeof_dpiSubscrCreateParams /*line :214:77*/)))
	defer func() { func() { _cgo0 := /*line :215:24*/unsafe.Pointer(params); _cgoCheckPointer(_cgo0, nil); /*line :215:47*/_Cfunc_free(_cgo0); }() }()
	func() _Ctype_int{ _cgo0 := /*line :216:38*/c.drv.dpiContext; _cgo1 := /*line :216:56*/params; _cgoCheckPointer(_cgo0, nil); _cgoCheckPointer(_cgo1, nil); return /*line :216:63*/_Cfunc_dpiContext_initSubscrCreateParams(_cgo0, _cgo1); }()
	params.subscrNamespace = ( /*line :217:27*/_Ciconst_DPI_SUBSCR_NAMESPACE_DBCHANGE /*line :217:57*/)
	params.protocol = ( /*line :218:20*/_Ciconst_DPI_SUBSCR_PROTO_CALLBACK /*line :218:46*/)
	params.qos = ( /*line :219:15*/_Ciconst_DPI_SUBSCR_QOS_BEST_EFFORT /*line :219:42*/) | ( /*line :219:46*/_Ciconst_DPI_SUBSCR_QOS_QUERY /*line :219:67*/) | ( /*line :219:71*/_Ciconst_DPI_SUBSCR_QOS_ROWIDS /*line :219:93*/)
	params.operations = ( /*line :220:22*/_Ciconst_DPI_OPCODE_ALL_OPS /*line :220:41*/)
	if name != "" || p.IPAddress != "" {
		if name != "" {
			params.name = ( /*line :223:18*/_Cfunc_CString /*line :223:26*/)(name)
			params.nameLength =  /*line :224:24*/_Ctype_uint32_t /*line :224:34*/(len(name))
		}
		if p.IPAddress != "" {
			params.ipAddress = ( /*line :227:23*/_Cfunc_CString /*line :227:31*/)(p.IPAddress)
			params.ipAddressLength =  /*line :228:29*/_Ctype_uint32_t /*line :228:39*/(len(p.IPAddress))
		}
		defer func() {
			if params.name != nil {
				func() { _cgo0 := /*line :232:12*/unsafe.Pointer(params.name); _cgoCheckPointer(_cgo0, nil); /*line :232:40*/_Cfunc_free(_cgo0); }()
			}
			if params.ipAddress != nil {
				func() { _cgo0 := /*line :235:12*/unsafe.Pointer(params.ipAddress); _cgoCheckPointer(_cgo0, nil); /*line :235:45*/_Cfunc_free(_cgo0); }()
			}
		}()
	}
	if p.Port != 0 {
		params.portNumber =  /*line :240:23*/_Ctype_uint32_t /*line :240:33*/(p.Port)
	}
	if p.ClientInitiated {
		params.clientInitiated =  /*line :243:28*/_Ctype_int /*line :243:33*/(1)
	}
	// typedef void (*dpiSubscrCallback)(void* context, dpiSubscrMessage *message);
	params.callback =  /*line :246:20*/_Ctype_dpiSubscrCallback /*line :246:39*/(( /*line :246:40*/_Cgo_ptr(_Cfpvar_fp_CallbackSubscrDebug) /*line :246:60*/))
	// cannot pass &subscr to C, so pass indirectly
	subscriptionsMu.Lock()
	subscriptionsID++
	subscr.ID = subscriptionsID
	subscriptions[subscr.ID] = &subscr
	subscriptionsMu.Unlock()
	subscrID := (* /*line :253:16*/_Ctype_uint64_t /*line :253:26*/)(( /*line :253:28*/_Cfunc__CMalloc /*line :253:35*/)(8))
	*subscrID =  /*line :254:14*/_Ctype_uint64_t /*line :254:24*/(subscriptionsID)
	params.callbackContext = unsafe.Pointer(subscrID)

	dpiSubscr := (* /*line :257:17*/_Ctype_dpiSubscr /*line :257:28*/)(( /*line :257:30*/_Cfunc__CMalloc /*line :257:37*/)(( /*line :257:39*/_Ciconst_sizeof_void /*line :257:51*/)))

	if err := c.checkExec(func()  /*line :259:31*/_Ctype_int /*line :259:36*/ {
		return func() _Ctype_int{ _cgo0 := /*line :260:30*/c.dpiConn; _cgo1 := /*line :260:41*/params; _cgoBase2 := /*line :260:80*/&dpiSubscr; _cgo2 := /*line :260:49*/(**_Ctype_dpiSubscr /*line :260:63*/)(unsafe.Pointer(_cgoBase2)); _cgoCheckPointer(_cgo0, nil); _cgoCheckPointer(_cgo1, nil); _cgoCheckPointer(_cgoBase2, 0 == 0); return /*line :260:93*/_Cfunc_dpiConn_subscribe(_cgo0, _cgo1, _cgo2); }()
	}); err != nil {
		func() { _cgo0 := /*line :262:10*/unsafe.Pointer(dpiSubscr); _cgoCheckPointer(_cgo0, nil); /*line :262:36*/_Cfunc_free(_cgo0); }()
		err = fmt.Errorf("newSubscription: %w", err)
		if strings.Contains(errors.Unwrap(err).Error(), "DPI-1065:") {
			err = fmt.Errorf("specify \"enableEvents=1\" connection parameter on connection to be able to use subscriptions: %w", err)
		}
		return nil, err
	}
	subscr.dpiSubscr = dpiSubscr
	return &subscr, nil
}

// Register a query for Change Notification.
//
// This code is EXPERIMENTAL yet!
func (s *Subscription) Register(qry string, params ...interface{}) error {
	runtime.LockOSThread()
	defer runtime.UnlockOSThread()

	cQry := ( /*line :280:10*/_Cfunc_CString /*line :280:18*/)(qry)
	defer func() func() { _cgo0 := /*line :281:15*/unsafe.Pointer(cQry); return func() { _cgoCheckPointer(_cgo0, nil); /*line :281:36*/_Cfunc_free(_cgo0); }}()()

	var dpiStmt * /*line :283:15*/_Ctype_dpiStmt /*line :283:24*/
	if func() _Ctype_int{ _cgo0 := /*line :284:29*/s.dpiSubscr; var _cgo1 *_Ctype_char = /*line :284:42*/cQry; var _cgo2 _Ctype_uint32_t = _Ctype_uint32_t /*line :284:58*/(len(qry)); _cgoBase3 := /*line :284:70*/&dpiStmt; _cgo3 := _cgoBase3; _cgoCheckPointer(_cgo0, nil); _cgoCheckPointer(_cgoBase3, 0 == 0); return /*line :284:79*/_Cfunc_dpiSubscr_prepareStmt(_cgo0, _cgo1, _cgo2, _cgo3); }() == ( /*line :284:83*/_Ciconst_DPI_FAILURE /*line :284:95*/) {
		return fmt.Errorf("prepareStmt[%p]: %w", s.dpiSubscr, s.conn.getError())
	}
	defer func() { func() _Ctype_int{ _cgo0 := /*line :287:35*/dpiStmt; _cgoCheckPointer(_cgo0, nil); return /*line :287:43*/_Cfunc_dpiStmt_release(_cgo0); }() }()

	mode :=  /*line :289:10*/_Ctype_dpiExecMode /*line :289:23*/(( /*line :289:24*/_Ciconst_DPI_MODE_EXEC_DEFAULT /*line :289:46*/))
	var qCols  /*line :290:12*/_Ctype_uint32_t /*line :290:22*/
	if func() _Ctype_int{ _cgo0 := /*line :291:23*/dpiStmt; var _cgo1 _Ctype_dpiExecMode = /*line :291:32*/mode; var _cgo2 *_Ctype_uint32_t = /*line :291:38*/&qCols; _cgoCheckPointer(_cgo0, nil); return /*line :291:45*/_Cfunc_dpiStmt_execute(_cgo0, _cgo1, _cgo2); }() == ( /*line :291:49*/_Ciconst_DPI_FAILURE /*line :291:61*/) {
		return fmt.Errorf("executeStmt: %w", s.conn.getError())
	}
	var queryID  /*line :294:14*/_Ctype_uint64_t /*line :294:24*/
	if func() _Ctype_int{ _cgo0 := /*line :295:32*/dpiStmt; var _cgo1 *_Ctype_uint64_t = /*line :295:41*/&queryID; _cgoCheckPointer(_cgo0, nil); return /*line :295:50*/_Cfunc_dpiStmt_getSubscrQueryId(_cgo0, _cgo1); }() == ( /*line :295:54*/_Ciconst_DPI_FAILURE /*line :295:66*/) {
		return fmt.Errorf("getSubscrQueryId: %w", s.conn.getError())
	}
	logger := getLogger(context.TODO())
	if logger != nil {
		logger.Debug("subscribed", "query", qry, "id", queryID)
	}

	return nil
}

// Close the subscription.
//
// This code is EXPERIMENTAL yet!
func (s *Subscription) Close() error {
	subscriptionsMu.Lock()
	delete(subscriptions, s.ID)
	subscriptionsMu.Unlock()
	dpiSubscr := s.dpiSubscr
	conn := s.conn
	s.conn = nil
	s.dpiSubscr = nil
	s.callback = nil
	if dpiSubscr == nil || conn == nil || conn.dpiConn == nil {
		return nil
	}
	if err := conn.checkExec(func()  /*line :321:34*/_Ctype_int /*line :321:39*/ { return func() _Ctype_int{ _cgo0 := /*line :321:71*/conn.dpiConn; _cgo1 := /*line :321:85*/dpiSubscr; _cgoCheckPointer(_cgo0, nil); _cgoCheckPointer(_cgo1, nil); return /*line :321:95*/_Cfunc_dpiConn_unsubscribe(_cgo0, _cgo1); }() }); err != nil {
		return fmt.Errorf("close: %w", err)
	}
	return nil
}

// EventType is the type of an event.
type EventType  /*line :328:16*/_Ctype_dpiEventType /*line :328:30*/

// Events that can be watched.
const (
	EvtStartup     = EventType(( /*line :332:29*/_Ciconst_DPI_EVENT_STARTUP /*line :332:47*/))
	EvtShutdown    = EventType(( /*line :333:29*/_Ciconst_DPI_EVENT_SHUTDOWN /*line :333:48*/))
	EvtShutdownAny = EventType(( /*line :334:29*/_Ciconst_DPI_EVENT_SHUTDOWN_ANY /*line :334:52*/))
	EvtDereg       = EventType(( /*line :335:29*/_Ciconst_DPI_EVENT_DEREG /*line :335:45*/))
	EvtObjChange   = EventType(( /*line :336:29*/_Ciconst_DPI_EVENT_OBJCHANGE /*line :336:49*/))
	EvtQueryChange = EventType(( /*line :337:29*/_Ciconst_DPI_EVENT_QUERYCHANGE /*line :337:51*/))
	EvtAQ          = EventType(( /*line :338:29*/_Ciconst_DPI_EVENT_AQ /*line :338:42*/))
)

// Operation in the DB.
type Operation  /*line :342:16*/_Ctype_dpiOpCode /*line :342:27*/

const (
	// OpAll Indicates that notifications should be sent for all operations on the table or query.
	OpAll = Operation(( /*line :346:20*/_Ciconst_DPI_OPCODE_ALL_OPS /*line :346:39*/))
	// OpAllRows Indicates that all rows have been changed in the table or query (or too many rows were changed or row information was not requested).
	OpAllRows = Operation(( /*line :348:24*/_Ciconst_DPI_OPCODE_ALL_ROWS /*line :348:44*/))
	// OpInsert Indicates that an insert operation has taken place in the table or query.
	OpInsert = Operation(( /*line :350:23*/_Ciconst_DPI_OPCODE_INSERT /*line :350:41*/))
	// OpUpdate Indicates that an update operation has taken place in the table or query.
	OpUpdate = Operation(( /*line :352:23*/_Ciconst_DPI_OPCODE_UPDATE /*line :352:41*/))
	// OpDelete Indicates that a delete operation has taken place in the table or query.
	OpDelete = Operation(( /*line :354:23*/_Ciconst_DPI_OPCODE_DELETE /*line :354:41*/))
	// OpAlter Indicates that the registered table or query has been altered.
	OpAlter = Operation(( /*line :356:22*/_Ciconst_DPI_OPCODE_ALTER /*line :356:39*/))
	// OpDrop Indicates that the registered table or query has been dropped.
	OpDrop = Operation(( /*line :358:21*/_Ciconst_DPI_OPCODE_DROP /*line :358:37*/))
	// OpUnknown An unknown operation has taken place.
	OpUnknown = Operation(( /*line :360:24*/_Ciconst_DPI_OPCODE_UNKNOWN /*line :360:43*/))
)
